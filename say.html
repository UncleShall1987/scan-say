<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Scan & Speak QR (with Camera Switch)</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 1.5rem;
      text-align: center;
    }
    #cameraSelect {
      font-size: 1rem;
      padding: 0.5rem;
      margin-bottom: 1rem;
    }
    #reader {
      width: 100%;
      max-width: 400px;
      margin: 1rem auto;
      border: 2px solid #666;
      border-radius: 8px;
      overflow: hidden;
    }
    #status {
      margin-top: 1rem;
      font-size: 1.25rem;
    }
  </style>

  <!-- Load html5-qrcode from CDN -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>
  <h1>üîç Scan & Speak QR üîà</h1>

  <!-- Camera dropdown -->
  <select id="cameraSelect">
    <option value="">Loading cameras...</option>
  </select>

  <!-- QR reader placeholder -->
  <div id="reader"></div>

  <div id="status">Point your camera at a QR code‚Ä¶</div>

  <script>
    // Reference to html5-qrcode scanner instance
    let html5QrcodeScanner = null;
    let currentCameraId = null;

    const statusEl = document.getElementById("status");
    const cameraSelectEl = document.getElementById("cameraSelect");

    // Called whenever a QR is successfully decoded
    function onScanSuccess(decodedText, decodedResult) {
      // Stop further scanning immediately
      html5QrcodeScanner.clear().catch(err => {
        console.warn("Failed to clear QR scanner:", err);
      });

      // Determine the name to speak:
      let nameToSpeak = decodedText;
      try {
        // If the QR text is a URL with ?name=XYZ, extract that
        const url = new URL(decodedText);
        const maybeName = url.searchParams.get("name");
        if (maybeName) {
          nameToSpeak = maybeName;
        }
      } catch (e) {
        // Not a URL‚Äîuse decodedText directly
      }

      statusEl.textContent = "üîà Speaking: " + nameToSpeak;
      const utter = new SpeechSynthesisUtterance(nameToSpeak);
      speechSynthesis.speak(utter);

      // Once speaking ends, update status (optional) and let user switch or rescan
      utter.onend = () => {
        statusEl.textContent = "‚úÖ Done speaking. Change camera or point at another QR.";
      };
    }

    // Called on scan failure (when no QR is found in a frame)
    function onScanFailure(errorMessage) {
      // We can ignore / debounce these errors
      // console.debug("QR scan failure:", errorMessage);
    }

    // Start scanning using the given cameraId
    function startScanner(cameraId) {
      if (html5QrcodeScanner) {
        html5QrcodeScanner.clear().catch(() => {
          /* ignore failure to clear */ 
        });
      }
      html5QrcodeScanner = new Html5Qrcode("reader");
      const config = { fps: 10, qrbox: 250 };

      html5QrcodeScanner
        .start(
          cameraId,
          config,
          onScanSuccess,
          onScanFailure
        )
        .then(() => {
          statusEl.textContent = "üì∑ Scanning with selected camera‚Ä¶";
        })
        .catch(err => {
          statusEl.textContent = "‚ùå Camera error: " + err;
        });
    }

    // Populate the camera dropdown and set up change handling
    function initializeCameraSelection() {
      Html5Qrcode.getCameras().then(cameras => {
        // Clear old options
        cameraSelectEl.innerHTML = "";
        if (!cameras || cameras.length === 0) {
          cameraSelectEl.innerHTML = "<option value=''>No cameras found</option>";
          statusEl.textContent = "‚ùå No cameras detected on this device.";
          return;
        }

        // Add an option for each camera
        cameras.forEach((cam, index) => {
          // Try to label ‚ÄúBack‚Äù vs ‚ÄúFront‚Äù when possible
          // Some devices include ‚Äúrear‚Äù or ‚Äúfront‚Äù in label; otherwise use index
          let label = cam.label || `Camera ${index + 1}`;
          label = label.toLowerCase().includes("front")
            ? "üì± Front (selfie)"
            : label.toLowerCase().includes("back")
            ? "üì∑ Rear"
            : `Camera ${index + 1}`;
          const option = document.createElement("option");
          option.value = cam.id;
          option.textContent = label;
          cameraSelectEl.appendChild(option);
        });

        // Default to the first camera
        currentCameraId = cameras[0].id;
        cameraSelectEl.value = currentCameraId;
        startScanner(currentCameraId);
      })
      .catch(err => {
        cameraSelectEl.innerHTML = "<option value=''>Cannot access cameras</option>";
        statusEl.textContent = "‚ùå Could not get camera list: " + err;
      });
    }

    // When the user picks a different camera from the dropdown
    cameraSelectEl.addEventListener("change", () => {
      const newCameraId = cameraSelectEl.value;
      if (!newCameraId) return;
      if (newCameraId === currentCameraId) return;
      currentCameraId = newCameraId;
      statusEl.textContent = "üîÑ Switching camera‚Ä¶";
      startScanner(currentCameraId);
    });

    // On page load, initialize camera list
    window.addEventListener("DOMContentLoaded", () => {
      initializeCameraSelection();
    });
  </script>
</body>
</html>
