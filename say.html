<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Arabic Name Scanner & Speaker</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; /* Align to top to see status message initially */
            min-height: 100vh;
            margin: 0;
            background-color: #f0f2f5;
            padding-top: 20px;
            box-sizing: border-box;
        }
        #app-container {
            width: 95%;
            max-width: 600px;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 20px;
            box-sizing: border-box;
        }
        #qr-reader {
            width: 100%;
            border: 1px solid #ccc;
            background-color: #f9f9f9;
            border-radius: 4px;
            overflow: hidden; /* Ensures child elements like video don't overflow */
        }
        /* Styling for the Html5QrcodeScanner's camera selection dropdown if needed */
        #qr-reader select {
            margin-top: 10px !important;
            padding: 8px !important;
            border-radius: 4px !important;
            border: 1px solid #ccc !important;
            background-color: white !important;
        }
        .result-container {
            text-align: center;
            padding: 20px;
            margin-top: 20px;
        }
        .arabic-name {
            font-size: 2.5em; /* Larger font for Arabic name */
            margin-bottom: 25px;
            color: #333;
            font-weight: 500;
            direction: rtl; /* Ensure Arabic text is right-to-left */
        }
        .controls button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 1.1em;
            border-radius: 5px;
            cursor: pointer;
            margin: 8px;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease;
            min-width: 180px;
        }
        .controls button:hover {
            background-color: #0056b3;
        }
        .controls button:active {
            transform: scale(0.98);
        }
        .controls button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .hidden {
            display: none !important;
        }
        #status-message {
            margin-bottom: 15px;
            color: #555;
            text-align: center;
            min-height: 20px; /* Reserve space for messages */
            font-size: 0.95em;
        }
        #app-title {
            font-size: 1.8em;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="app-container">
        <h1 id="app-title">ŸÖÿßÿ≥ÿ≠ ŸàŸÖŸÜÿ∑ŸàŸÇ ÿßŸÑÿ£ÿ≥ŸÖÿßÿ° ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</h1>
        <div id="status-message">ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±...</div>

        <div id="scanner-container">
            <div id="qr-reader"></div>
        </div>

        <div id="result-container" class="result-container hidden">
            <div id="detected-name" class="arabic-name"></div>
            <div class="controls">
                <button id="speak-name-button" disabled>‚ñ∂Ô∏è ŸÜÿ∑ŸÇ ÿßŸÑÿßÿ≥ŸÖ</button>
                <button id="scan-another-button">üîÑ ŸÖÿ≥ÿ≠ ÿ±ŸÖÿ≤ ÿ¨ÿØŸäÿØ</button>
            </div>
        </div>
    </div>

    <audio id="tts-audio" style="display:none;"></audio>

    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script>
        // Fallback definitions for library constants (though they should be available globally)
        const Html5QrcodeScanType = window.Html5QrcodeScanType || { SCAN_TYPE_CAMERA: 0 };
        const Html5QrcodeScannerState = window.Html5QrcodeScannerState || { SCANNING: 1, PAUSED: 2, IDLE: 0 }; // IDLE is often 0 or similar for "not scanning"

        document.addEventListener('DOMContentLoaded', () => {
            const qrReaderDivId = "qr-reader";
            const scannerContainer = document.getElementById('scanner-container');
            const resultContainer = document.getElementById('result-container');
            const detectedNameDiv = document.getElementById('detected-name');
            const speakNameButton = document.getElementById('speak-name-button');
            const scanAnotherButton = document.getElementById('scan-another-button');
            const ttsAudio = document.getElementById('tts-audio');
            const statusMessage = document.getElementById('status-message');

            const voiceRSSApiKey = "1994072a28604a5d9a23bdc4c3a91ea8";
            let currentArabicName = "";
            let currentTtsUrl = "";
            let html5QrcodeScanner; // Instance of Html5QrcodeScanner

            if (window.location.protocol !== "https:" && window.location.hostname !== "localhost" && !window.location.hostname.startsWith("127.")) {
                statusMessage.innerHTML = "<b>ÿ™ŸÜÿ®ŸäŸá ÿ£ŸÖŸÜŸä:</b> Ÿäÿ™ÿ∑ŸÑÿ® ÿßŸÑŸàÿµŸàŸÑ ÿ•ŸÑŸâ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß ÿßÿ™ÿµÿßŸÑÿßŸã ÿ¢ŸÖŸÜÿßŸã (HTTPS) ÿ£Ÿà ÿßŸÑÿπŸÖŸÑ ÿπŸÑŸâ ÿßŸÑŸÖÿ∂ŸäŸÅ ÿßŸÑŸÖÿ≠ŸÑŸä (localhost). Ÿäÿ±ÿ¨Ÿâ ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ© ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ HTTPS.";
                if(scannerContainer) scannerContainer.style.display = 'none';
                return;
            }

            function initializeScanner() {
                const qrReaderElement = document.getElementById(qrReaderDivId);
                if (!qrReaderElement) {
                    console.error("QR Reader element not found.");
                    statusMessage.textContent = "ÿÆÿ∑ÿ£: ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿπŸÜÿµÿ± ŸÇÿßÿ±ÿ¶ QR.";
                    return;
                }
                qrReaderElement.innerHTML = ''; // Clear previous scanner UI

                scannerContainer.classList.remove('hidden');
                resultContainer.classList.add('hidden');
                statusMessage.textContent = "ÿ¨ÿßÿ±Ÿä ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑŸÖÿßÿ≥ÿ≠ ÿßŸÑÿ∂Ÿàÿ¶Ÿä...";

                const scannerConfig = {
                    fps: 10,
                    qrbox: (viewfinderWidth, viewfinderHeight) => {
                        const minDimension = Math.min(viewfinderWidth, viewfinderHeight);
                        const qrBoxSize = Math.min(280, Math.floor(minDimension * 0.75)); // Adjusted size
                        return { width: qrBoxSize, height: qrBoxSize };
                    },
                    rememberLastUsedCamera: true,
                    videoConstraints: {
                        facingMode: "environment" // Prioritize rear camera
                    },
                    supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA]
                };

                try {
                    html5QrcodeScanner = new Html5QrcodeScanner(
                        qrReaderDivId,
                        scannerConfig,
                        /* verbose= */ false
                    );
                    html5QrcodeScanner.render(onScanSuccess, onScanFailure);
                    statusMessage.textContent = "ÿ∂ÿπ ÿ±ŸÖÿ≤ QR ŸÅŸä ÿ•ÿ∑ÿßÿ± ÿßŸÑÿπÿ±ÿ∂. ÿßÿ≥ŸÖÿ≠ ÿ®ÿßŸÑŸàÿµŸàŸÑ ÿ•ŸÑŸâ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß ÿ•ÿ∞ÿß ÿ∑ŸèŸÑÿ® ŸÖŸÜŸÉ.";
                } catch (e) {
                    console.error("Error initializing Html5QrcodeScanner:", e);
                    statusMessage.textContent = "ŸÅÿ¥ŸÑ ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑŸÖÿßÿ≥ÿ≠ ÿßŸÑÿ∂Ÿàÿ¶Ÿä. ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ£ŸÜ ŸÖÿ™ÿµŸÅÿ≠ŸÉ ŸäÿØÿπŸÖ ÿßŸÑŸàÿµŸàŸÑ ÿ•ŸÑŸâ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß Ÿàÿ≠ÿßŸàŸÑ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿµŸÅÿ≠ÿ©.";
                }
            }

            function onScanSuccess(decodedText, decodedResult) {
                console.log(`Scan detected: ${decodedText}`, decodedResult);
                statusMessage.textContent = "ÿ™ŸÖ ÿßŸÉÿ™ÿ¥ÿßŸÅ ÿ±ŸÖÿ≤ QR! ÿ¨ÿßÿ±Ÿä ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ©...";

                if (html5QrcodeScanner && typeof html5QrcodeScanner.clear === 'function') {
                    html5QrcodeScanner.clear()
                        .then(() => {
                            console.log("Html5QrcodeScanner cleared successfully after scan.");
                        })
                        .catch(error => {
                            console.error("Error clearing Html5QrcodeScanner after scan:", error);
                        })
                        .finally(() => {
                            processDecodedText(decodedText);
                        });
                } else {
                    processDecodedText(decodedText);
                }
            }
            
            function processDecodedText(decodedText) {
                let arabicName = "";
                let nameFound = false;

                try {
                    let urlObj;
                    try { urlObj = new URL(decodedText); } catch (_) { /* Not a valid URL, proceed */ }

                    if (urlObj && (urlObj.protocol === "http:" || urlObj.protocol === "https:")) {
                        if (urlObj.searchParams.has("name")) {
                            arabicName = decodeURIComponent(urlObj.searchParams.get("name"));
                            nameFound = true;
                            console.log("Extracted name from URL parameter:", arabicName);
                        }
                    }
                } catch (e) {
                    console.error("Error during name extraction from URL logic:", e);
                }

                if (!nameFound) {
                    arabicName = decodedText;
                    console.log("Using plain decoded text as name:", arabicName);
                }

                currentArabicName = arabicName.trim();

                if (!currentArabicName) {
                    detectedNameDiv.textContent = "ÿÆÿ∑ÿ£: ŸÑŸÖ Ÿäÿ™ŸÖŸÉŸÜ ŸÖŸÜ ÿßÿ≥ÿ™ÿÆŸÑÿßÿµ ÿßÿ≥ŸÖ ÿµÿßŸÑÿ≠ ŸÖŸÜ ÿ±ŸÖÿ≤ QR.";
                    speakNameButton.disabled = true;
                } else {
                    detectedNameDiv.textContent = currentArabicName;
                    speakNameButton.disabled = false;
                    speakText(currentArabicName);
                }

                scannerContainer.classList.add('hidden');
                resultContainer.classList.remove('hidden');
            }


            function onScanFailure(error) {
                // This can be called frequently. Keep logging minimal unless debugging.
                // Example: if (error.toLowerCase().includes("no qr code found")) {
                //    statusMessage.textContent = "ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿ±ŸÖÿ≤ QR...";
                // }
            }

            function speakText(text) {
                if (!text) {
                    console.warn("SpeakText called with no text.");
                    return;
                }
                const encodedText = encodeURIComponent(text);
                currentTtsUrl = `https://api.voicerss.org/?key=${voiceRSSApiKey}&hl=ar-sa&c=MP3&src=${encodedText}&f=48khz_16bit_stereo`;
                
                ttsAudio.src = currentTtsUrl;
                ttsAudio.play().catch(e => {
                    console.error("Error playing TTS audio:", e);
                    if (e.name === "NotAllowedError") {
                        statusMessage.textContent = "ÿ™ŸÖ ÿ≠ÿ∏ÿ± ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä ŸÑŸÑÿµŸàÿ™. ÿßŸÜŸÇÿ± ÿπŸÑŸâ 'ŸÜÿ∑ŸÇ ÿßŸÑÿßÿ≥ŸÖ' ŸÑŸÑÿ™ÿ¥ÿ∫ŸäŸÑ.";
                    } else {
                        statusMessage.textContent = "ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿµŸàÿ™. ÿßŸÜŸÇÿ± ÿπŸÑŸâ 'ŸÜÿ∑ŸÇ ÿßŸÑÿßÿ≥ŸÖ' ŸÑŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.";
                    }
                });
            }

            speakNameButton.addEventListener('click', () => {
                if (currentTtsUrl) {
                    ttsAudio.currentTime = 0;
                    ttsAudio.play().catch(e => {
                        console.error("Error re-playing TTS audio:", e);
                        statusMessage.textContent = "ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿπÿßÿØÿ© ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿµŸàÿ™.";
                    });
                } else if (currentArabicName) {
                    speakText(currentArabicName);
                } else {
                    statusMessage.textContent = "ŸÑÿß ŸäŸàÿ¨ÿØ ÿßÿ≥ŸÖ ŸÖŸÉÿ™ÿ¥ŸÅ ŸÑŸÜÿ∑ŸÇŸá.";
                }
            });

            scanAnotherButton.addEventListener('click', () => {
                currentArabicName = "";
                currentTtsUrl = "";
                detectedNameDiv.textContent = "";
                speakNameButton.disabled = true;

                // The scanner should have been cleared in onScanSuccess.
                // Re-initialize will clean the div and create a new scanner instance.
                initializeScanner();
            });

            initializeScanner(); // Start the scanner on page load
        });
    </script>
</body>
</html>
