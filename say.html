<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>QR → Arabic Name Scanner + OpenAI TTS</title>

  <!-- Html5QrcodeScanner library (CDN) -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Arial, sans-serif;
      background-color: #f9f9f9;
    }
    #scanner-container,
    #result-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
    }
    #reader {
      width: 300px;
      max-width: 90%;
    }
    #name-display {
      font-size: 1.5em;
      margin: 20px 0;
      direction: rtl; /* RTL for Arabic text */
    }
    button {
      padding: 10px 20px;
      font-size: 1em;
      margin: 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- Scanner view (visible on load and whenever you click “Scan Another”) -->
  <div id="scanner-container">
    <div id="reader"></div>
  </div>

  <!-- Post-scan view (hidden until a QR is decoded) -->
  <div id="result-container" style="display: none;">
    <p id="name-display"></p>
    <button id="speak-btn">▶️ Speak Name</button>
    <button id="scan-btn">🔄 Scan Another</button>
  </div>

  <script>
    // ───────────────────────────────────────────────────────────────────────────────
    // ► Paste your OpenAI key here (the user provided “sk-proj-ItVWhD…”).
    //   WARNING: For a production app, do NOT store your secret key in client-side code.
    const OPENAI_KEY = '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';
    // ───────────────────────────────────────────────────────────────────────────────

    let currentName = '';
    let currentAudioUrl = null; // stores the blob URL of the last TTS
    let scanner = null;

    /**
     * (Re)initializes the Html5QrcodeScanner on #reader.
     * Uses a “soft” camera preference (ideal: environment) to avoid OverconstrainedError.
     */
    function initScanner() {
      // Hide post-scan UI, show scanner UI
      document.getElementById('result-container').style.display = 'none';
      document.getElementById('scanner-container').style.display = 'flex';

      // Clear the #reader container (in case we’re restarting)
      const container = document.getElementById('scanner-container');
      container.innerHTML = '<div id="reader"></div>';

      // Soft preference for rear camera:
      const config = {
        fps: 10,
        qrbox: 250,
        videoConstraints: {
          facingMode: { ideal: "environment" }
        }
      };

      // Instantiate Html5QrcodeScanner
      scanner = new Html5QrcodeScanner("reader", config, /* verbose= */ false);
      scanner.render(onScanSuccess);
    }

    /**
     * Called when a QR code is successfully decoded.
     * Stops the scanner, extracts an Arabic name, calls OpenAI TTS, and switches UI.
     */
    function onScanSuccess(decodedText, decodedResult) {
      // 1) Stop & clear the scanner → turns off camera
      scanner.clear().then(() => {
        // 2) Extract Arabic name:
        //    • If decodedText is a URL with “?name=…”, URL-decode that.
        //    • Otherwise treat decodedText as plain Arabic text.
        let name = '';
        try {
          const possibleUrl = new URL(decodedText);
          const param = possibleUrl.searchParams.get('name');
          if (param) {
            name = decodeURIComponent(param);
          } else {
            name = decodedText;
          }
        } catch (e) {
          // Not a valid URL → treat as plain Arabic
          name = decodedText;
        }

        currentName = name;
        document.getElementById('name-display').innerText = name;

        // 3) Call OpenAI TTS endpoint with `model: "tts-1"` and get back an MP3.
        //    We send JSON: { model:"tts-1", input: name, voice:"alloy", format:"mp3" }
        //    The response is a binary MP3, which we turn into a Blob, then createObjectURL.
        fetch("https://api.openai.com/v1/audio/speech", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + OPENAI_KEY
          },
          body: JSON.stringify({
            model: "tts-1",
            input: name,
            voice: "alloy",
            format: "mp3"
          })
        })
        .then(response => {
          if (!response.ok) {
            return response.text().then(txt => { throw new Error(txt) });
          }
          return response.blob();
        })
        .then(blob => {
          // Create a local URL for the MP3 blob
          if (currentAudioUrl) {
            URL.revokeObjectURL(currentAudioUrl);
          }
          currentAudioUrl = URL.createObjectURL(blob);

          // Auto-play the new audio
          const audio = new Audio(currentAudioUrl);
          audio.play().catch(err => {
            console.warn("Autoplay blocked or failed:", err);
          });

          // 4) Show the “post-scan” UI, hide scanner UI
          document.getElementById('scanner-container').style.display = 'none';
          document.getElementById('result-container').style.display = 'flex';
        })
        .catch(err => {
          console.error("Error calling OpenAI TTS:", err);
          alert("Failed to generate TTS. See console for details.");
          // If TTS fails, still show the name and let user scan again
          document.getElementById('scanner-container').style.display = 'none';
          document.getElementById('result-container').style.display = 'flex';
        });
      })
      .catch(err => {
        console.error("Error clearing scanner:", err);
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      // 1) Start scanning immediately on page load
      initScanner();

      // 2) “▶️ Speak Name” button: re-play the last TTS blob
      document.getElementById('speak-btn').addEventListener('click', () => {
        if (currentAudioUrl) {
          const audio = new Audio(currentAudioUrl);
          audio.play().catch(err => {
            console.warn("Replay blocked:", err);
          });
        }
      });

      // 3) “🔄 Scan Another”: clear old scanner & restart
      document.getElementById('scan-btn').addEventListener('click', () => {
        if (scanner) {
          scanner.clear().catch(() => { /* ignore errors */ });
        }
        initScanner();
      });
    });
  </script>
</body>
</html>
